<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments :: page_head('Your Account Details', 'none')" />
<link rel="stylesheet" type="text/css" th:href="@{/css/account.css(v=3)}" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<body>
<div th:replace="navigation :: menu"></div>

<div class="account-container">
    <!-- Page Header -->
    <div class="account-header">
        <h1 class="account-title">
            <i class="fas fa-user-circle"></i>
            Your Account Details
        </h1>
        <a th:href="@{/}" class="back-button">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <!-- Main Form Card -->
    <div class="account-form-card">
        <form th:action="@{/account/update}" method="post" enctype="multipart/form-data" th:object="${user}">
            <input type="hidden" th:field="*{id}" />


            <!-- Success Message -->
            <div th:if="${message != null}" class="success-alert">
                <i class="fas fa-check-circle"></i>
                <span>[[${message}]]</span>
            </div>

            <!-- Profile Photo Section -->
            <div class="profile-photo-section">
                <input type="hidden" th:field="*{photos}" />
                <div class="profile-photo-wrapper">
                    <img id="thumbnail" alt="Profile Photo" 
                         th:src="@{'/user-photos/' + ${user.photos} + '?v=' + ${#dates.format(#dates.createNow(), 'yyyyMMddHHmmss')}}" 
                         onerror="this.src='/images/default-user.png'"
                         class="profile-thumbnail" />
                    <label for="fileImage" class="photo-label">
                        <i class="fas fa-camera"></i>
                        Change Profile Photo
                    </label>
                    <input type="file" id="fileImage" name="image" accept="image/png, image/jpeg" 
                           class="form-control photo-input" />
                </div>
            </div>

            <!-- Email (readonly) -->
            <div class="form-section">
                <label class="form-label">
                    <i class="fas fa-envelope"></i> Email Address
                </label>
                <input type="email" class="form-control" th:field="*{email}" readonly />
            </div>

            <!-- First & Last Name -->
            <div class="form-row">
                <div class="form-section">
                    <label class="form-label">
                        <i class="fas fa-user"></i> First Name
                    </label>
                    <input type="text" class="form-control" th:field="*{firstName}" 
                           required minlength="2" maxlength="45" placeholder="Enter your first name" />
                </div>
                <div class="form-section">
                    <label class="form-label">
                        <i class="fas fa-user"></i> Last Name
                    </label>
                    <input type="text" class="form-control" th:field="*{lastName}" 
                           required minlength="2" maxlength="45" placeholder="Enter your last name" />
                </div>
            </div>

            <!-- Password & Confirm Password -->
            <div class="form-row">
                <div class="form-section">
                    <label class="form-label">
                        <i class="fas fa-lock"></i> Password
                    </label>
                    <input type="password" th:field="*{password}" id="password" class="form-control"
                           placeholder="Leave blank to keep current password" minlength="8" maxlength="20"
                           oninput="checkPasswordMatch(document.getElementById('confirmPassword'))" />
                </div>
                <div class="form-section">
                    <label class="form-label">
                        <i class="fas fa-lock"></i> Confirm Password
                    </label>
                    <input type="password" id="confirmPassword" class="form-control" 
                           minlength="8" maxlength="20" placeholder="Confirm your password"
                           oninput="checkPasswordMatch(this)" />
                </div>
            </div>

            <!-- Phone & City -->
            <div class="form-row">
                <div class="form-section">
                    <label class="form-label">
                        <i class="fas fa-phone"></i> Phone Number
                    </label>
                    <input type="text" th:field="*{phoneNumber}" class="form-control" 
                           required maxlength="15" minlength="8" placeholder="+1 (555) 123-4567" />
                </div>
                <div class="form-section">
                    <label class="form-label">
                        <i class="fas fa-city"></i> City
                    </label>
                    <input type="text" th:field="*{city}" class="form-control" 
                           maxlength="45" minlength="2" placeholder="Enter your city" />
                </div>
            </div>

            <!-- Address Line 1 -->
            <div class="form-section">
                <label class="form-label">
                    <i class="fas fa-map-marker-alt"></i> Address Line 1
                </label>
                <input type="text" th:field="*{addressLine1}" class="form-control" 
                       required maxlength="64" minlength="3" placeholder="Street address" />
            </div>

            <!-- Address Line 2 -->
            <div class="form-section">
                <label class="form-label">
                    <i class="fas fa-map-marker-alt"></i> Address Line 2
                </label>
                <input type="text" th:field="*{addressLine2}" class="form-control" 
                       maxlength="64" placeholder="Apartment, suite, unit, etc. (optional)" />
            </div>

            <!-- State & Postal Code -->
            <div class="form-row">
                <div class="form-section">
                    <label class="form-label">
                        <i class="fas fa-map"></i> State/Province
                    </label>
                    <input type="text" th:field="*{state}" class="form-control" 
                           maxlength="45" minlength="3" placeholder="State or Province" />
                </div>
                <div class="form-section">
                    <label class="form-label">
                        <i class="fas fa-mail-bulk"></i> Postal Code
                    </label>
                    <input type="text" th:field="*{postalCode}" class="form-control" 
                           maxlength="10" minlength="2" placeholder="Postal/ZIP code" />
                </div>
            </div>


            <!-- Action Buttons -->
            <div class="action-buttons">
                <button type="submit" class="btn-save">
                    <i class="fas fa-save"></i> Save Changes
                </button>
                <button type="button" class="btn-cancel" id="buttonCancel">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<div th:replace="fragments :: footer"></div>

<script type="text/javascript">
    // Set variables for common_form.js
    var moduleURL = "[[@{/}]]";
    var MAX_FILE_SIZE = 1048576; // 1MB

    // Password matching validation
    function checkPasswordMatch(confirmPassword) {
        const originalPassword = document.getElementById("password");
        if (confirmPassword.value !== originalPassword.value) {
            confirmPassword.setCustomValidity("Passwords do not match!");
        } else {
            confirmPassword.setCustomValidity("");
        }
    }

    // Image preview functionality
    $(document).ready(function() {
        $("#buttonCancel").on("click", function() {
            window.location = moduleURL;
        });

        $("#fileImage").change(function() {
            if (!checkFileSize(this)) {
                return;
            }
            showImageThumbnail(this);
        });
    });

    function showImageThumbnail(fileInput) {
        var file = fileInput.files[0];
        var reader = new FileReader();
        reader.onload = function(e) {
            $("#thumbnail").attr("src", e.target.result);
        };
        reader.readAsDataURL(file);
    }

    function checkFileSize(fileInput) {
        fileSize = fileInput.files[0].size;
        if (fileSize > MAX_FILE_SIZE) {
            fileInput.setCustomValidity("You must choose an image less than " + MAX_FILE_SIZE + " bytes!");
            fileInput.reportValidity();
            return false;
        } else {
            fileInput.setCustomValidity("");
            return true;
        }
    }
</script>
</body>
</html>
